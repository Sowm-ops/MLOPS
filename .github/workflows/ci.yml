name: CI Pipeline with model training DVC and S3

permissions:
  contents: write

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "params.yaml"
      - "dvc.yaml"
      - "dvc.lock"
      - "data/**"
      - "models/**"
      - "metrics/**"
      - "tests/**"
      - ".github/workflows/ci.yml"

jobs:
  mlops:
    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ap-south-1

    steps:

      # ----------------------------------------------------
      # CHECKOUT
      # ----------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------------------
      # PYTHON
      # ----------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # ----------------------------------------------------
      # DEPENDENCIES
      # ----------------------------------------------------
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc[s3] pytest evidently

      # ----------------------------------------------------
      # DVC CONFIG
      # ----------------------------------------------------
      - name: Configure DVC Remote (S3)
        run: |
          dvc remote modify origin access_key_id $AWS_ACCESS_KEY_ID --local
          dvc remote modify origin secret_access_key $AWS_SECRET_ACCESS_KEY --local
          dvc remote modify origin region ap-south-1 --local

      # ----------------------------------------------------
      # DVC PULL
      # ----------------------------------------------------
      - name: Pull data + models from S3
        run: dvc pull -v --force

      # ----------------------------------------------------
      # NLTK
      # ----------------------------------------------------
      - name: Download NLTK Data
        run: |
          python - <<EOF
          import nltk
          nltk.download('punkt')
          nltk.download('punkt_tab')
          nltk.download('stopwords')
          nltk.download('wordnet')
          nltk.download('omw-1.4')
          EOF

      # ----------------------------------------------------
      # RUN TEST SUITE 
      # ----------------------------------------------------
      - name: Run Tests (data, model, preprocessing, pipeline)
        run: |
          echo 'Running pytest test suite...'
          pytest -q

      - name: Stop pipeline when tests fail
        if: failure()
        run: |
          echo "❌ Test suite failed. Stopping CI."
          exit 1

      # ----------------------------------------------------
      # ONLY IF TESTS PASS → Train models
      # ----------------------------------------------------

      - name: Run Data Preparation
        run: python src/data_prep.py

      - name: Run Training
        run: python src/train.py

      - name: Run DVC Repro
        run: dvc repro

      - name: Push updated artifacts to S3
        run: dvc push -v

      # ----------------------------------------------------
      # COMMIT METADATA
      # ----------------------------------------------------
      - name: Commit updated DVC metadata + metrics
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add . || true
          git commit -m "Auto-update: metrics + DVC pipeline outputs" || true
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/Sowm-ops/MLOPS.git HEAD:main || true

      # ----------------------------------------------------
      # UPLOAD METRICS
      # ----------------------------------------------------
      - name: Upload metrics (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: metrics
          path: metrics/
